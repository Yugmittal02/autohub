import React, { useState, useEffect, useRef } from 'react';
import { ArrowLeft, Calculator, FileText, Percent, DollarSign, RefreshCcw, Activity, Pin, StickyNote, CreditCard, Languages, Share2, Plus, Trash2, Copy } from 'lucide-react';
import { FloatingNoteMenu } from './FloatingNoteMenu';
import VoiceInput from './VoiceInput';
import DOMPurify from 'dompurify';

// Imported Tools
import GstCalculator from './tools/GstCalculator';
import EmiCalculator from './tools/EmiCalculator';
import MarginCalculator from './tools/MarginCalculator';
import UnitConverter from './tools/UnitConverter';
import StockValueCalculator from './tools/StockValueCalculator';
import DigitalBusinessCard from './tools/DigitalBusinessCard';
import NoteMaster from './tools/NoteMaster';
import QuotationMaker from './tools/QuotationMaker';

// Assuming basic translate helper is available, or passed as prop. 
// The original code used `translateWithGoogle` global or imported? 
// It seemed to be defined in App.tsx or similar and passed down?
// Oh, `translateWithGoogle` was used in `handleTranslate` which was inside ToolsHub.
// I need to check where `translateWithGoogle` comes from. 
// It was interacting with `ToolsHub` state.
// Wait, I saw `let result = await translateWithGoogle(...)` in line 202.
// It seems `translateWithGoogle` is imported or global. I will assume it's available or imported.
// If it was not imported in the file view, it might be a global function or I missed an import.
// Let's assume I need to keep it working.

// Since I am keeping Translator inline, I need `translateWithGoogle`.
// I'll add a dummy placeholder or try to find where it is.
// Actually, looking at previous logs, `ToolsHub.tsx` didn't show imports.
// I'll assume it's imported.

// Mock for translateWithGoogle if not found, but I should try to import it if I can finding it.
// I'll check imports later if it fails. For now, I'll assume it is in scope or imported.

import { AppData, ShopDetails } from '../types';

interface ToolsHubProps {
    onBack: () => void;
    t: (key: string) => string;
    isDark: boolean;
    initialTool?: string | null;
    initialNoteId?: string | number | null;
    pinnedTools?: string[];
    onTogglePin?: (toolId: string) => void;
    shopDetails: ShopDetails;
    data: AppData;
}

const ToolsHub: React.FC<ToolsHubProps> = ({ onBack, t, isDark, initialTool = null, initialNoteId = null, pinnedTools, onTogglePin, shopDetails, data }) => {
    const [activeTool, setActiveTool] = useState<string | null>(initialTool);

    // Initial tool effect
    useEffect(() => {
        if (initialTool) setActiveTool(initialTool);
    }, [initialTool]);

    // ?? BUSINESS CALCULATOR STATE
    const [calcExpression, setCalcExpression] = useState('');
    const [calcResult, setCalcResult] = useState('0');
    const [calcHistory, setCalcHistory] = useState<string[]>([]);

    // Calculate Effect
    useEffect(() => {
        try {
            // Safety check for safe eval
            if (/^[0-9+\-*/.() ]+$/.test(calcExpression)) {
                // eslint-disable-next-line no-eval
                const result = eval(calcExpression);
                if (isFinite(result) && !isNaN(result)) {
                    const formatted = Number(result.toFixed(6)).toString();
                    setCalcResult(formatted);
                }
            }
        } catch (e) {
            // Ignore incomplete expressions
        }
    }, [calcExpression, activeTool]);


    // ?? INVOICE GENERATOR STATE
    const [invoiceNumber] = useState(Date.now().toString().slice(-6)); // Simple random ID
    const [invItems, setInvItems] = useState<any[]>([]);
    const [invCust, setInvCust] = useState({ name: '', phone: '', gstNo: '' });
    const [invSettings, setInvSettings] = useState({ showGst: true, discount: 0, discountType: 'flat', paymentMode: 'cash', invoiceType: 'retail', notes: '' });
    const [invCurrentItem, setInvCurrentItem] = useState({ name: '', qty: 1, rate: 0, gst: 18, unit: 'pcs', hsn: '' });

    // ?? TRANSLATOR STATE
    const [transInput, setTransInput] = useState('');
    const [transOutput, setTransOutput] = useState('');
    const [transLang, setTransLang] = useState({ from: 'en', to: 'hi' });
    const [transLoading, setTransLoading] = useState(false);
    const [transHistory, setTransHistory] = useState<any[]>([]);

    const tools = [
        { id: 'basicCalc', name: 'Business Calc', icon: <Calculator size={24} />, color: 'bg-teal-100 text-teal-600', desc: 'Quick Calculator' },
        { id: 'quotation', name: 'Quotation', icon: <FileText size={24} />, color: 'bg-indigo-100 text-indigo-600', desc: 'Make Estimates' },
        { id: 'invoice', name: 'Bill Generator', icon: <FileText size={24} />, color: 'bg-blue-100 text-blue-600', desc: 'GST & Retail Bills' },
        { id: 'gst', name: 'GST Pro', icon: <Percent size={24} />, color: 'bg-blue-100 text-blue-600', desc: 'Calculate GST' },
        { id: 'margin', name: 'Profit Analyzer', icon: <Calculator size={24} />, color: 'bg-purple-100 text-purple-600', desc: 'Margin & Markup' },
        { id: 'emi', name: 'EMI Calculator', icon: <DollarSign size={24} />, color: 'bg-emerald-100 text-emerald-600', desc: 'Loan EMI Calc' },
        { id: 'converter', name: 'Unit Convert', icon: <RefreshCcw size={24} />, color: 'bg-green-100 text-green-600', desc: 'KG, Tons, Feet' },
        { id: 'stockvalue', name: 'Stock Value', icon: <Activity size={24} />, color: 'bg-cyan-100 text-cyan-600', desc: 'Inventory Worth' },
        { id: 'card', name: 'Digital Card', icon: <CreditCard size={24} />, color: 'bg-orange-100 text-orange-600', desc: 'Business Card' },
        { id: 'notes', name: 'Note Master', icon: <StickyNote size={24} />, color: 'bg-yellow-100 text-yellow-600', desc: 'Smart Notes' },
        { id: 'translator', name: 'AI Translator', icon: <Languages size={24} />, color: 'bg-pink-100 text-pink-600', desc: 'Multi-Language' },
    ];

    const languageOptions = [
        { code: 'en', name: 'English' }, { code: 'hi', name: 'Hindi' }, { code: 'gu', name: 'Gujarati' },
        { code: 'mr', name: 'Marathi' }, { code: 'ta', name: 'Tamil' }, { code: 'te', name: 'Telugu' },
        { code: 'bn', name: 'Bengali' }, { code: 'pa', name: 'Punjabi' }, { code: 'ur', name: 'Urdu' }, { code: 'ar', name: 'Arabic' },
    ];

    // TODO: Need to ensure translateWithGoogle is imported
    const translateWithGoogle = async (text: string, from: string, to: string) => {
        // Placeholder if global not found, but it should be there.
        // Assuming it fetches from an API.
        const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=${from}&tl=${to}&dt=t&q=${encodeURIComponent(text)}`);
        const data = await res.json();
        return data[0][0][0];
    }

    const handleTranslate = async () => {
        if (!transInput.trim()) return;
        setTransLoading(true);
        try {
            let result = await translateWithGoogle(transInput, transLang.from, transLang.to);
            setTransOutput(result);
            setTransHistory(prev => [{ input: transInput, output: result, from: transLang.from, to: transLang.to }, ...prev.slice(0, 9)]);
        } catch (e) {
            setTransOutput('Translation failed. Please try again.');
        }
        setTransLoading(false);
    };

    const swapLanguages = () => {
        setTransLang({ from: transLang.to, to: transLang.from });
        setTransInput(transOutput);
        setTransOutput('');
    };

    // Invoice Logic
    const addInvItem = () => {
        if (!invCurrentItem.name || !invCurrentItem.rate) return;
        const baseTotal = invCurrentItem.qty * invCurrentItem.rate;
        const gstAmt = invSettings.showGst ? (baseTotal * invCurrentItem.gst) / 100 : 0;
        const newItem = {
            ...invCurrentItem,
            id: Date.now(),
            baseTotal,
            gstAmt,
            total: baseTotal + gstAmt
        };
        setInvItems([...invItems, newItem]);
        setInvCurrentItem({ name: '', qty: 1, rate: 0, gst: 18, unit: 'pcs', hsn: '' });
    };

    const deleteInvItem = (id: any) => setInvItems(invItems.filter(i => i.id !== id));

    const calculateBillTotals = () => {
        const subtotal = invItems.reduce((acc, curr) => acc + curr.baseTotal, 0);
        const totalGst = invItems.reduce((acc, curr) => acc + curr.gstAmt, 0);
        const discountAmt = invSettings.discountType === 'percent'
            ? (subtotal * invSettings.discount / 100)
            : invSettings.discount;
        const grandTotal = subtotal + totalGst - discountAmt;
        return { subtotal, totalGst, discountAmt, grandTotal };
    };

    const shareInvoiceImage = async () => {
        try {
            alert("Share functionality requires device capabilities.");
        } catch (e) { console.error(e); }
    };

    const renderToolContent = () => {
        const commonInputClass = `w-full p-3 rounded-xl border font-bold text-lg mb-4 ${isDark ? 'bg-slate-800 border-slate-600 text-white' : 'bg-gray-50 border-gray-300 text-black'}`;
        const cardClass = `p-6 rounded-2xl shadow-lg border h-full flex flex-col ${isDark ? 'bg-slate-800 border-slate-700' : 'bg-white border-gray-100'}`;
        const totals = calculateBillTotals();

        switch (activeTool) {
            case 'gst': return <GstCalculator t={t} />;
            case 'margin': return <MarginCalculator />;
            case 'emi': return <EmiCalculator />;
            case 'converter': return <UnitConverter />;
            case 'stockvalue': return <StockValueCalculator />;
            case 'card': return <DigitalBusinessCard shopDetails={shopDetails} />;
            case 'notes': return <NoteMaster t={t} isDark={isDark} initialNoteId={initialNoteId} />;
            case 'quotation': return <QuotationMaker t={t} shopDetails={shopDetails} data={data} isDark={isDark} />;

            case 'basicCalc': {
                const handleCalcInput = (value: string) => {
                    setCalcExpression(prev => prev + value);
                };

                const handleOperator = (op: string) => {
                    if (calcExpression === '' && op !== '-') return;
                    const lastChar = calcExpression.slice(-1);
                    if (['+', '-', '*', '/', '.'].includes(lastChar)) {
                        setCalcExpression(prev => prev.slice(0, -1) + op);
                    } else {
                        setCalcExpression(prev => prev + op);
                    }
                };

                const finalizeResult = () => {
                    if (calcResult !== 'Error' && calcResult !== '0') {
                        const historyEntry = `${calcExpression} = ${calcResult}`;
                        setCalcHistory(prev => [historyEntry, ...prev.slice(0, 9)]);
                        setCalcExpression(calcResult);
                    }
                };

                const clearCalc = () => {
                    setCalcExpression('');
                    setCalcResult('0');
                };

                const backspace = () => {
                    setCalcExpression(prev => prev.slice(0, -1));
                };

                const buttons = [
                    { label: 'C', action: clearCalc, color: 'bg-red-500 text-white shadow-red-500/30' },
                    { label: '(', action: () => handleCalcInput('('), color: 'bg-gray-200 dark:bg-slate-700 dark:text-gray-300' },
                    { label: ')', action: () => handleCalcInput(')'), color: 'bg-gray-200 dark:bg-slate-700 dark:text-gray-300' },
                    { label: '√∑', action: () => handleOperator('/'), color: 'bg-indigo-500 text-white shadow-indigo-500/30' },
                    { label: '7', action: () => handleCalcInput('7'), color: 'bg-white dark:bg-slate-800' },
                    { label: '8', action: () => handleCalcInput('8'), color: 'bg-white dark:bg-slate-800' },
                    { label: '9', action: () => handleCalcInput('9'), color: 'bg-white dark:bg-slate-800' },
                    { label: '√ó', action: () => handleOperator('*'), color: 'bg-indigo-500 text-white shadow-indigo-500/30' },
                    { label: '4', action: () => handleCalcInput('4'), color: 'bg-white dark:bg-slate-800' },
                    { label: '5', action: () => handleCalcInput('5'), color: 'bg-white dark:bg-slate-800' },
                    { label: '6', action: () => handleCalcInput('6'), color: 'bg-white dark:bg-slate-800' },
                    { label: '-', action: () => handleOperator('-'), color: 'bg-indigo-500 text-white shadow-indigo-500/30' },
                    { label: '1', action: () => handleCalcInput('1'), color: 'bg-white dark:bg-slate-800' },
                    { label: '2', action: () => handleCalcInput('2'), color: 'bg-white dark:bg-slate-800' },
                    { label: '3', action: () => handleCalcInput('3'), color: 'bg-white dark:bg-slate-800' },
                    { label: '+', action: () => handleOperator('+'), color: 'bg-indigo-500 text-white shadow-indigo-500/30' },
                    { label: '0', action: () => handleCalcInput('0'), color: 'bg-white dark:bg-slate-800 col-span-1' },
                    { label: '.', action: () => handleCalcInput('.'), color: 'bg-white dark:bg-slate-800' },
                    { label: '‚å´', action: backspace, color: 'bg-orange-500 text-white shadow-orange-500/30' },
                    { label: '=', action: finalizeResult, color: 'bg-gradient-to-r from-green-500 to-emerald-600 text-white shadow-emerald-500/30' },
                ];

                return (
                    <div className={cardClass}>
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="font-bold text-2xl flex items-center gap-2">
                                <Calculator className="text-indigo-500" size={24} />
                                Calculator
                            </h3>
                        </div>

                        {/* Display Area */}
                        <div className={`p-6 rounded-3xl mb-6 shadow-inner flex flex-col items-end justify-end h-32 transition-colors ${isDark ? 'bg-black/40' : 'bg-gray-100'}`}>
                            {/* Expression (Small) */}
                            <div className={`text-right w-full mb-1 text-lg font-medium tracking-wide overflow-x-auto whitespace-nowrap hide-scrollbar opacity-60 ${isDark ? 'text-gray-300' : 'text-gray-600'}`}>
                                {calcExpression || '0'}
                            </div>

                            {/* Result (Big) */}
                            <div className={`text-right w-full text-5xl font-black tracking-tight overflow-x-auto whitespace-nowrap hide-scrollbar ${isDark ? 'text-white' : 'text-slate-800'}`}>
                                {calcResult}
                            </div>
                        </div>

                        {/* Keypad */}
                        <div className="grid grid-cols-4 gap-3 flex-1">
                            {buttons.map((btn, idx) => (
                                <button
                                    key={idx}
                                    onClick={(e) => {
                                        const target = e.currentTarget;
                                        target.classList.add('scale-90');
                                        setTimeout(() => target.classList.remove('scale-90'), 100);
                                        btn.action();
                                    }}
                                    className={`
                                        relative overflow-hidden
                                        h-16 rounded-2xl font-bold text-xl transition-all duration-100 ease-out
                                        flex items-center justify-center
                                        active:scale-95 hover:brightness-110 shadow-sm
                                        ${btn.color}
                                        ${isDark && btn.color.includes('bg-white') ? '!bg-slate-800 !text-white !shadow-slate-900/50' : ''}
                                    `}
                                >
                                    {btn.label}
                                </button>
                            ))}
                        </div>

                        {/* History */}
                        {calcHistory.length > 0 && (
                            <div className="mt-6 pt-4 border-t border-dashed border-gray-300 dark:border-gray-700">
                                <p className="text-xs font-bold uppercase tracking-wider mb-2 opacity-50">History</p>
                                <div className="flex gap-2 overflow-x-auto pb-2 hide-scrollbar">
                                    {calcHistory.slice(0, 5).map((entry, idx) => (
                                        <div
                                            key={idx}
                                            onClick={() => {
                                                const parts = entry.split(' = ');
                                                if (parts[1]) {
                                                    setCalcExpression(parts[1]);
                                                    setCalcResult(parts[1]);
                                                }
                                            }}
                                            className={`flex-shrink-0 px-3 py-1.5 rounded-lg text-xs font-mono cursor-pointer border transition-colors ${isDark ? 'bg-slate-800 border-slate-700 hover:bg-slate-700' : 'bg-white border-gray-200 hover:bg-gray-50'}`}
                                        >
                                            {entry}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                );
            }
            case 'invoice':
                return (
                    <div className={`${cardClass} overflow-y-auto`}>
                        <div className="flex justify-between items-center mb-4 border-b pb-3">
                            <div className="flex items-center gap-2">
                                <FileText className="text-indigo-500" size={24} />
                                <div>
                                    <h3 className="font-bold text-lg">Invoice Pro</h3>
                                    <p className="text-xs text-gray-500">#{invoiceNumber}</p>
                                </div>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={shareInvoiceImage} className="p-2 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-xl flex items-center gap-1 text-sm font-bold shadow-lg hover:shadow-xl transition-all">
                                    <Share2 size={16} /> Share
                                </button>
                            </div>
                        </div>
                        <div className="flex gap-2 mb-4 bg-indigo-50 p-1.5 rounded-xl">
                            {[
                                { id: 'retail', label: 'üõçÔ∏è Retail', desc: 'Simple Bill' },
                                { id: 'gst', label: 'üìã GST Invoice', desc: 'With Tax' },
                                { id: 'estimate', label: 'üìÑ Estimate', desc: 'Quotation' }
                            ].map(type => (
                                <button
                                    key={type.id}
                                    onClick={() => setInvSettings({ ...invSettings, invoiceType: type.id, showGst: type.id === 'gst' })}
                                    className={`flex-1 py-2 px-1 rounded-lg text-xs font-bold transition-all ${invSettings.invoiceType === type.id
                                        ? 'bg-white shadow-md text-indigo-600'
                                        : 'text-gray-500 hover:text-indigo-400'
                                        }`}
                                >
                                    {type.label}
                                </button>
                            ))}
                        </div>

                        {/* PREVIEW AREA */}
                        <div className="flex justify-center bg-gradient-to-br from-gray-100 to-gray-200 p-3 rounded-xl mb-4 overflow-hidden">
                            <div className="bg-white text-black p-4 border shadow-2xl rounded-lg text-xs w-full max-w-[320px]" id="invoice-area">
                                <div className="text-center border-b-2 border-indigo-600 pb-2 mb-3">
                                    <h2 className="text-lg font-black uppercase tracking-wider text-indigo-700">{shopDetails.shopName || "My Shop"}</h2>
                                    <p className="text-[8px] uppercase text-gray-500 tracking-widest">
                                        {invSettings.invoiceType === 'gst' ? 'TAX INVOICE' : invSettings.invoiceType === 'estimate' ? 'ESTIMATE / QUOTATION' : 'RETAIL INVOICE'}
                                    </p>
                                </div>
                                <div className="flex justify-between mb-3 text-[10px] bg-gray-50 p-2 rounded">
                                    <div>
                                        <p className="text-gray-500 text-[8px]">BILL TO:</p>
                                        <p className="font-bold">{invCust.name || 'Walk-in Customer'}</p>
                                        <p>{invCust.phone}</p>
                                        {invCust.gstNo && <p className="text-[8px] text-gray-500">GSTIN: {invCust.gstNo}</p>}
                                    </div>
                                    <div className="text-right">
                                        <p className="font-bold text-indigo-600">#{invoiceNumber}</p>
                                        <p>{new Date().toLocaleDateString('en-IN')}</p>
                                        <p className="text-[8px] text-gray-500">{invSettings.paymentMode.toUpperCase()}</p>
                                    </div>
                                </div>
                                <table className="w-full text-left mb-3 border-collapse">
                                    <thead>
                                        <tr className="bg-indigo-600 text-white text-[9px] uppercase">
                                            <th className="py-1.5 px-1 rounded-tl">Item</th>
                                            <th className="py-1.5 text-center">Qty</th>
                                            <th className="py-1.5 text-right">Rate</th>
                                            {invSettings.showGst && <th className="py-1.5 text-right">GST</th>}
                                            <th className="py-1.5 text-right rounded-tr pr-1">Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody className="text-[10px]">
                                        {invItems.map((item, idx) => (
                                            <tr key={item.id} className={idx % 2 === 0 ? 'bg-gray-50' : ''}>
                                                <td className="py-1.5 px-1">
                                                    <span className="font-medium">{item.name}</span>
                                                    {item.hsn && <span className="block text-[7px] text-gray-400">HSN: {item.hsn}</span>}
                                                </td>
                                                <td className="py-1.5 text-center">{item.qty} {item.unit}</td>
                                                <td className="py-1.5 text-right">‚Çπ{item.rate}</td>
                                                {invSettings.showGst && <td className="py-1.5 text-right">{item.gst}%</td>}
                                                <td className="py-1.5 text-right pr-1">‚Çπ{Number(item.total || 0).toFixed(2)}</td>
                                            </tr>
                                        ))}
                                        {invItems.length === 0 && (
                                            <tr><td colSpan={5} className="py-4 text-center text-gray-400">No items added</td></tr>
                                        )}
                                    </tbody>
                                </table>
                                <div className="border-t-2 border-gray-300 pt-2 space-y-1 text-[10px]">
                                    <div className="flex justify-between text-gray-600">
                                        <span>Subtotal</span>
                                        <span>‚Çπ{totals.subtotal.toFixed(2)}</span>
                                    </div>
                                    {invSettings.showGst && (
                                        <div className="flex justify-between text-indigo-600">
                                            <span>GST</span>
                                            <span>‚Çπ{totals.totalGst.toFixed(2)}</span>
                                        </div>
                                    )}
                                    {invSettings.discount > 0 && (
                                        <div className="flex justify-between text-green-600">
                                            <span>Discount</span>
                                            <span>-‚Çπ{totals.discountAmt.toFixed(2)}</span>
                                        </div>
                                    )}
                                    <div className="flex justify-between text-lg font-black border-t-2 border-indigo-600 pt-2 mt-2">
                                        <span>TOTAL</span>
                                        <span className="text-indigo-700">‚Çπ{totals.grandTotal.toFixed(2)}</span>
                                    </div>
                                </div>
                                {invSettings.notes && (
                                    <div className="mt-2 p-2 bg-yellow-50 rounded text-[8px] text-yellow-800">
                                        <strong>Note:</strong> {invSettings.notes}
                                    </div>
                                )}
                                <div className="mt-3 text-center text-[8px] text-gray-400 border-t pt-2">Thank you for your business!</div>
                            </div>
                        </div>

                        <div className="grid grid-cols-2 gap-2 mb-3">
                            <input className="p-2.5 border-2 rounded-xl text-sm font-medium focus:border-indigo-400 outline-none" placeholder="Customer Name" value={invCust.name} onChange={e => setInvCust({ ...invCust, name: e.target.value })} />
                            <input className="p-2.5 border-2 rounded-xl text-sm focus:border-indigo-400 outline-none" placeholder="Mobile Number" value={invCust.phone} onChange={e => setInvCust({ ...invCust, phone: e.target.value })} />
                        </div>
                        {invSettings.invoiceType === 'gst' && (
                            <input className="w-full p-2.5 border-2 rounded-xl text-sm mb-3 focus:border-indigo-400 outline-none" placeholder="Customer GSTIN (Optional)" value={invCust.gstNo} onChange={e => setInvCust({ ...invCust, gstNo: e.target.value })} />
                        )}

                        <div className="bg-gradient-to-br from-indigo-50 to-purple-50 p-4 rounded-xl border-2 border-indigo-100 mb-4">
                            <p className="text-xs font-bold text-indigo-600 mb-2">ADD ITEM</p>
                            <div className="grid grid-cols-2 gap-2 mb-2">
                                <input className="col-span-2 p-2.5 border-2 rounded-xl font-bold text-sm" placeholder="Item Name *" value={invCurrentItem.name} onChange={e => setInvCurrentItem({ ...invCurrentItem, name: e.target.value })} />
                                {invSettings.showGst && (
                                    <input className="p-2 border-2 rounded-lg text-sm" placeholder="HSN Code" value={invCurrentItem.hsn} onChange={e => setInvCurrentItem({ ...invCurrentItem, hsn: e.target.value })} />
                                )}
                            </div>
                            <div className="grid grid-cols-4 gap-2">
                                <input type="number" className="p-2 border-2 rounded-lg text-sm font-bold" placeholder="Qty" value={invCurrentItem.qty} onChange={e => setInvCurrentItem({ ...invCurrentItem, qty: parseInt(e.target.value) || 1 })} />
                                <input type="number" className="p-2 border-2 rounded-lg text-sm" placeholder="Rate ‚Çπ" value={invCurrentItem.rate || ''} onChange={e => setInvCurrentItem({ ...invCurrentItem, rate: parseFloat(e.target.value) })} />
                                {invSettings.showGst && (
                                    <select className="p-2 border-2 rounded-lg text-sm" value={invCurrentItem.gst} onChange={e => setInvCurrentItem({ ...invCurrentItem, gst: parseInt(e.target.value) })}>
                                        <option value={0}>0%</option>
                                        <option value={5}>5%</option>
                                        <option value={12}>12%</option>
                                        <option value={18}>18%</option>
                                        <option value={28}>28%</option>
                                    </select>
                                )}
                                <button onClick={addInvItem} className="bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-xl font-bold flex items-center justify-center shadow-lg hover:shadow-xl transition-all">
                                    <Plus size={20} />
                                </button>
                            </div>
                        </div>

                        <div className="grid grid-cols-2 gap-2 mb-3">
                            <select
                                className="p-2 border-2 rounded-xl text-sm"
                                value={invSettings.paymentMode}
                                onChange={e => setInvSettings({ ...invSettings, paymentMode: e.target.value })}
                            >
                                <option value="cash">üíµ Cash</option>
                                <option value="upi">üì± UPI</option>
                                <option value="card">üí≥ Card</option>
                                <option value="credit">üìù Credit</option>
                            </select>
                            <div className="flex">
                                <input
                                    type="number"
                                    className="flex-1 p-2 border-2 rounded-l-xl text-sm"
                                    placeholder="Discount"
                                    value={invSettings.discount || ''}
                                    onChange={e => setInvSettings({ ...invSettings, discount: parseFloat(e.target.value) || 0 })}
                                />
                                <select
                                    className="p-2 border-2 border-l-0 rounded-r-xl text-sm"
                                    value={invSettings.discountType}
                                    onChange={e => setInvSettings({ ...invSettings, discountType: e.target.value })}
                                >
                                    <option value="flat">‚Çπ</option>
                                    <option value="percent">%</option>
                                </select>
                            </div>
                        </div>

                        {invItems.length > 0 && (
                            <div className="mb-3 space-y-1">
                                {invItems.map(item => (
                                    <div key={item.id} className="flex items-center justify-between p-2 bg-gray-50 rounded-lg text-sm">
                                        <span className="font-medium">{item.name} √ó {item.qty}</span>
                                        <div className="flex items-center gap-2">
                                            <span className="font-bold">‚Çπ{item.total.toFixed(0)}</span>
                                            <button onClick={() => deleteInvItem(item.id)} className="text-red-500 p-1 hover:bg-red-50 rounded"><Trash2 size={14} /></button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                        {invItems.length > 0 &&
                            <button onClick={() => setInvItems([])} className="text-red-500 text-xs text-center w-full bg-red-50 p-2 rounded-xl font-bold">
                                Clear All Items
                            </button>
                        }
                    </div>
                );

            case 'translator':
                return (
                    <div className={cardClass}>
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="font-bold text-xl flex items-center gap-2">
                                <Languages className="text-pink-500" size={24} />
                                AI Translator Pro
                            </h3>
                        </div>

                        <div className="flex items-center gap-2 mb-4 bg-gray-50 p-2 rounded-xl border">
                            <select
                                className="flex-1 bg-transparent font-bold text-sm outline-none"
                                value={transLang.from}
                                onChange={e => setTransLang({ ...transLang, from: e.target.value })}
                            >
                                {languageOptions.map(l => <option key={l.code} value={l.code}>{l.name}</option>)}
                            </select>
                            <button onClick={swapLanguages} className="p-2 rounded-full hover:bg-gray-200 transition-all">
                                <RefreshCcw size={16} />
                            </button>
                            <select
                                className="flex-1 bg-transparent font-bold text-sm outline-none text-right"
                                value={transLang.to}
                                onChange={e => setTransLang({ ...transLang, to: e.target.value })}
                            >
                                {languageOptions.map(l => <option key={l.code} value={l.code}>{l.name}</option>)}
                            </select>
                        </div>

                        <div className="relative mb-4">
                            <textarea
                                className={`${commonInputClass} min-h-[120px] resize-none pr-12`}
                                placeholder="Type text to translate..."
                                value={transInput}
                                onChange={e => setTransInput(e.target.value)}
                            />
                            <div className="absolute bottom-6 right-4">
                                <VoiceInput onResult={(txt: string) => setTransInput(txt)} lang={transLang.from} isDark={isDark} />
                            </div>
                        </div>

                        <button
                            onClick={handleTranslate}
                            disabled={transLoading || !transInput.trim()}
                            className="w-full py-3 bg-gradient-to-r from-pink-500 to-purple-600 text-white rounded-xl font-boldshadow-lg hover:shadow-xl transition-all disabled:opacity-50 disabled:cursor-not-allowed flex justify-center items-center gap-2"
                        >
                            {transLoading ? <RefreshCcw className="animate-spin" size={20} /> : <Languages size={20} />}
                            {transLoading ? 'Translating...' : 'Translate Now'}
                        </button>

                        {transOutput && (
                            <div className="mt-4 animate-in slide-in-from-bottom-2 fade-in">
                                <p className="text-xs font-bold text-gray-500 mb-1">TRANSLATION</p>
                                <div className="p-4 bg-gradient-to-br from-pink-50 to-purple-50 rounded-2xl border-2 border-pink-100 relative">
                                    <p className="text-lg font-medium leading-relaxed">{transOutput}</p>
                                    <button
                                        onClick={() => navigator.clipboard.writeText(transOutput)}
                                        className="absolute top-2 right-2 p-2 text-pink-400 hover:bg-pink-100 rounded-lg transition-all"
                                    >
                                        <Copy size={16} />
                                    </button>
                                </div>
                            </div>
                        )}

                        {transHistory.length > 0 && (
                            <div className="mt-6 border-t pt-4">
                                <p className="text-xs font-bold text-gray-400 mb-3 uppercase tracking-wider">History</p>
                                <div className="space-y-2 max-h-40 overflow-y-auto pr-1">
                                    {transHistory.map((item, i) => (
                                        <div key={i} className="p-3 bg-gray-50 rounded-xl hover:bg-gray-100 transition-all cursor-pointer border" onClick={() => { setTransInput(item.input); setTransOutput(item.output); }}>
                                            <p className="text-xs text-gray-500 mb-1 line-clamp-1">{item.input}</p>
                                            <p className="text-sm font-bold text-gray-800 line-clamp-1">{item.output}</p>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                );
            default: return null;
        }
    };

    return (
        <div className={`fixed inset-0 z-[60] overflow-y-auto ${isDark ? 'bg-slate-950 text-white' : 'bg-gray-50 text-black'}`}>
            <div className={`sticky top-0 p-4 border-b flex items-center gap-3 ${isDark ? 'bg-slate-900 border-slate-800' : 'bg-white border-gray-200'}`}>
                {activeTool ? (
                    <button onClick={() => setActiveTool(null)} className="p-2 rounded-full hover:bg-gray-100/10"><ArrowLeft size={24} /></button>
                ) : (
                    <button onClick={onBack} className="p-2 rounded-full hover:bg-gray-100/10"><ArrowLeft size={24} /></button>
                )}
                <div>
                    <h1 className="text-xl font-bold">{activeTool ? tools.find(toolItem => toolItem.id === activeTool)?.name : t("Business Tools")}</h1>
                    {!activeTool && <p className="text-xs text-gray-500">Industry-ready business utilities</p>}
                </div>
            </div>

            <div className="p-4 max-w-md mx-auto min-h-screen">
                {!activeTool && (
                    <div className="grid grid-cols-2 gap-3 mt-2">
                        {tools.map(tool => {
                            const isPinned = pinnedTools.includes(tool.id);
                            return (
                                <div
                                    key={tool.id}
                                    className={`relative p-4 rounded-2xl border flex flex-col items-center justify-center gap-2 transition-all hover:scale-[1.02] active:scale-[0.98] cursor-pointer ${isDark ? 'bg-slate-800 border-slate-700 hover:bg-slate-700' : 'bg-white border-gray-200 hover:border-blue-400 hover:shadow-lg shadow-sm'}`}
                                    onClick={() => setActiveTool(tool.id)}
                                >
                                    <div className={`p-3 rounded-2xl ${tool.color} shadow-sm`}>{tool.icon}</div>
                                    <span className="font-bold text-sm text-center">{t(tool.name)}</span>
                                    <span className="text-[10px] text-gray-500 text-center">{tool.desc}</span>
                                    <button
                                        onClick={(e) => { e.stopPropagation(); onTogglePin(tool.id); }}
                                        className={`absolute top-2 right-2 p-1.5 rounded-full transition-all ${isPinned ? 'text-blue-500 bg-blue-100' : 'text-gray-300 hover:text-gray-500 hover:bg-gray-100'}`}
                                    >
                                        {isPinned ? <Pin size={14} fill="currentColor" /> : <Pin size={14} />}
                                    </button>
                                </div>
                            );
                        })}
                        <div className="col-span-2 text-center text-xs opacity-50 mt-4 flex items-center justify-center gap-1">
                            <Pin size={10} /> Pin tools to Home Screen for quick access
                        </div>
                    </div>
                )}
                {activeTool && <div className="animate-in slide-in-from-right duration-300 mt-4 h-full">{renderToolContent()}</div>}
            </div>
        </div>
    );
};
export default ToolsHub;
